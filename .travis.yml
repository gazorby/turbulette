dist: xenial
language: python
python:
- 3.8
- 3.6
- 3.7
stages:
- test
- name: deploy
  if: tag IS present

# Tests
before_install:
- pip install poetry
install:
- export PYTHONPATH=$PYTHONPATH:$(pwd)/turbulette
- poetry install --no-root -v
services:
- postgresql
env:
  - DB_DRIVER=postgresql DB_HOST=localhost DB_PORT=5432 DB_USER=postgres DB_PASSWORD=""
    PYTEST_TURBULETTE_SETTINGS=tests.settings
before_script:
- psql -c 'create database test;' -U postgres
script: pytest

jobs:
  include:
    - stage: deploy
      script: skip
      before_deploy:
        - pip install --upgrade pip
        - pip install poetry
        - poetry build
      deploy:
        provider: script
        script: poetry publish
        skip_cleanup: true
        username: __token__
        password:
          secure: FrUwAuekhylPYcoqe15IdI5Og8wF/IFBzmyCpsXEa5hlEiRrdpwGnER6dOTzz6CJosksQvEF0xw+BIaU+SVD2TimWP6B7dqvbX9VF70mUWsQeECrnQFtPeVTO40xPWQVUtWZeDqgY36ZyWLLagJfE1fYP0MwGiEdR+wbNa6Uy22lOv4Uk8gDV7cxNa9CMWE5+YgpeCxnOC5c6Ju6hwNf8JJL3BOz6e6C1qhRLSM6/kuGwuXFx3t6zrzasR/NhyToc898FJJYKN0M50Vx9roINGrItvXTPyaEQp9tKyqCkZM7mWevM+ebZbm5T9XaJJC5bib0+w6BRlyaENQgUHM82pF8bZJxtkzU91IBSgY9ol3rNiPqanrAI+FvH2GR4uSAGgTziiei+F0JrRX9vFo/MIJESCLrNl9nCCXeDF6CS3/u1/+IfVHFMV/9jsRLT2YTcIaDzHVk4W/5wn8wtklUBD/0SQgkZH7xbIB308R8302l662wddukoZcKj4M1hBXQM4CqfBDI34hF6vJy1eYtYwawCsF1YVToqt2I3L/7vDKAtLGmH6MnxWhdsgg57kG3tvUq5CW1sMguI0qoxOmj8H8FOxMGwgjF+mVIvV8OwdHwWvHZ7h8KT2RHdAniXnuYoxcmucXPd2Mo9w4ymt7llyw4ULhMsHHAkEogMYjskNY=
        on:
          tags: true
          repo: gazorby/turbulette


after_success:
- bash <(curl -s https://codecov.io/bash)
